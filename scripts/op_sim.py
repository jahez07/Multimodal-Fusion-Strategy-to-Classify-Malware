import os
import hashlib
import numpy as np

# Define the path to the folder containing your documents
main_folder = "/Users/jahezabrahamjohny/Jahez/Research_CyberSecurity/MalHub/MalHub_OpCode"

simhash_folder = "/Users/jahezabrahamjohny/Jahez/Research_CyberSecurity/MalHub/SimCode"

# Define the dimension of the SimHash vector
n = 512

# Function to calculate SimHash Code 's' for a document
def calculate_simhash(document_content):
    v = np.zeros(n, dtype=int)  # Initialize the 'v' vector as an array of zeros
    s = [0] * n
    
    # Hash function using MD5 (you can use a different hash function if needed)
    def hash_function(data):
        return int(hashlib.sha512(data.encode()).hexdigest(), 16) % (2 ** n)

    # Split the document content into keywords (you might need to adapt this based on your document structure)
    keywords = document_content.split()
    
    # Calculate the hash value for each keyword and update the 'v' vector
    for keyword in keywords:
        b = hash_function(keyword)
        for i in range(n):
            if (b >> i) & 1 == 1:
                v[i] += 1
            else:
                v[i] -= 1
        for i in range(n):
            if v[i] > 0:
                s[i] = 1
            else:
                s[i] = 0
    
    return s

# Process each document in the folder
for folder in os.listdir(main_folder):
    print(folder)
    for filename in os.listdir(os.path.join(main_folder, folder)):
        if filename.endswith(".txt"):  # Assuming your documents have a .txt extension
            # Read the content of the document
            with open(os.path.join(main_folder, folder, filename), "r") as file:
                document_content = file.read()
        
            # Calculate the SimHash Code 's'
            simhash_code = calculate_simhash(document_content)
            folder_path = os.path.join(simhash_folder,folder)
            if not os.path.exists(folder_path):
                os.makedirs(folder_path)

            # Save the SimHash Code 's' to a new file in the SimHash folder
            simhash_filename = os.path.splitext(filename)[0] + ".txt"
            with open(os.path.join(folder_path, simhash_filename), "w") as file:
                file.write(" ".join(map(str, simhash_code)))  # Write the vector as space-separated values
            print("Name:%20s\tFamily: %15s" % (simhash_filename, folder))


